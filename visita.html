<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitas Veterinárias - Vet 2°rcg System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f7ff 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ESTILOS DA TELA DE VISITAS */
        #filesPage {
            display: block;
            min-height: 100vh;
            padding: 20px;
            animation: fadeIn 0.8s ease;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #2c7fb8;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-image-small {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #2c7fb8;
            overflow: hidden;
        }
        
        .logo-image-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .logo-text h1 {
            color: #2c7fb8;
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .logo-text p {
            color: #666;
            font-size: 14px;
        }
        
        .user-info {
            text-align: right;
        }
        
        .user-info span {
            color: #2c7fb8;
            font-weight: 600;
        }
        
        .btn-logout {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 5px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-logout:hover {
            background: #c0392b;
        }
        
        .main-container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .page-title {
            color: #2c7fb8;
            margin-bottom: 25px;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .page-title svg {
            width: 30px;
            height: 30px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #2c7fb8;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1d5f8a;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #7fcdbb;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5bbfa5;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #219653;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .btn-voltar {
            background: #f39c12;
            color: white;
            margin-bottom: 20px;
        }
        
        .btn-voltar:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }
        
        /* NOVOS ESTILOS PARA CADERNO DE VISITAS */
        .caderno-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .caderno-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .caderno-date {
            font-weight: 600;
            color: #2c7fb8;
            font-size: 18px;
        }
        
        .caderno-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        
        .caderno-status.active {
            background: #27ae60;
        }
        
        .caderno-status.inactive {
            background: #7f8c8d;
        }
        
        .caderno-status.pending {
            background: #f39c12;
        }
        
        .caderno-actions {
            display: flex;
            gap: 10px;
        }
        
        /* NOVO LAYOUT PARA LISTAS LADO A LADO */
        .caderno-lists-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1024px) {
            .caderno-lists-container {
                grid-template-columns: 1fr;
            }
        }
        
        .esquadrao-list {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .esquadrao-header {
            padding: 15px;
            background: #2c7fb8;
            color: white;
            font-weight: 600;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .esquadrao-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .esquadrao-content {
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .horse-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .horse-item {
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .horse-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .horse-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .horse-name {
            font-weight: 600;
            color: #2c7fb8;
            font-size: 16px;
        }
        
        .horse-id {
            font-size: 12px;
            color: #666;
        }
        
        .horse-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .visit-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .btn-remove {
            background: #e74c3c;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-remove:hover {
            background: #c0392b;
        }
        
        .observacoes-section {
            margin-bottom: 20px;
        }
        
        .observacoes-section h3 {
            color: #2c7fb8;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .observacoes-textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
        }
        
        .observacoes-textarea:focus {
            border-color: #2c7fb8;
            outline: none;
            box-shadow: 0 0 0 3px rgba(44, 127, 184, 0.2);
        }
        
        .archived-visitas {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        .archived-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .archived-item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .archived-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .archived-date {
            font-weight: 600;
            color: #2c7fb8;
            margin-bottom: 10px;
        }
        
        .archived-count {
            font-size: 14px;
            color: #666;
        }
        
        .warning-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #e74c3c;
            font-size: 20px;
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
            grid-column: 1 / -1;
        }
        
        /* MODAL PARA CRIAR NOVO CADERNO */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            color: #2c7fb8;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #2c7fb8;
            outline: none;
            box-shadow: 0 0 0 3px rgba(44, 127, 184, 0.2);
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }
        
        /* MODAL DE VISITA ARQUIVADA */
        .modal-wide {
            max-width: 900px;
        }
        
        .modal-archived-content {
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-archived-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #2c7fb8;
        }
        
        .modal-archived-date {
            font-size: 20px;
            font-weight: 600;
            color: #2c7fb8;
        }
        
        .modal-archived-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .stat-box {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #2c7fb8;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .modal-observacoes {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .modal-observacoes h4 {
            color: #2c7fb8;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .user-info {
                text-align: center;
            }
            
            .caderno-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .caderno-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .modal-archived-stats {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- TELA DE VISITAS -->
    <div id="filesPage">
        <div class="header">
            <div class="logo-section">
                <div class="logo-image-small">
                    <img src="2-rcg-926x926 (1).jpg" alt="Logo Veterinária">
                </div>
                <div class="logo-text">
                    <h1>Vet 2°rcg System</h1>
                    <p>Gestão de Visitas Veterinárias</p>
                    <p>Atualização diaria pela Enfermeiro Veterinário de dia.</p>
                </div>
            </div>
            <div class="user-info">
                <p>Logado como: <span id="loggedUser">Administrador</span></p>
                <button class="btn btn-voltar" id="btnVoltar">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Voltar para Arquivos
                </button>
            </div>
        </div>
        
        <div class="main-container">
            <h1 class="page-title">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 21V5C19 3.89543 18.1046 3 17 3H7C5.89543 3 5 3.89543 5 5V21M19 21L21 21M19 21H14M5 21L3 21M5 21H10M9 6.99998H15M9 11H15M9 15H13" stroke="#2c7fb8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Visitas Veterinárias
            </h1>
            
            <div class="caderno-header">
                <div class="caderno-info">
                    <div class="caderno-date" id="currentCadernoDate">Nenhum caderno ativo</div>
                    <div class="caderno-status inactive" id="cadernoStatus">Inativo</div>
                </div>
                <div class="caderno-actions">
                    <button class="btn btn-primary" id="btnNovoCaderno">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 5V19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Novo Caderno
                    </button>
                    <button class="btn btn-success" id="btnFinalizarVisita" disabled>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18455 2.99721 7.13631 4.39828 5.49706C5.79935 3.85781 7.69279 2.71537 9.79619 2.24013C11.8996 1.7649 14.1003 1.98232 16.07 2.85999" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 4L12 14.01L9 11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Finalizar Serviço
                    </button>
                </div>
            </div>
            
            <div class="observacoes-section">
                <h3>Observações do dia:</h3>
                <textarea class="observacoes-textarea" id="observacoesDia" placeholder="Registre aqui observações importantes do dia..."></textarea>
            </div>
            
            <div class="caderno-lists-container" id="cadernoListsContainer" style="display: none;">
                <div class="esquadrao-list">
                    <div class="esquadrao-header">
                        <span>Hipo</span>
                        <span class="esquadrao-count" id="hipoCount">0 cavalos</span>
                    </div>
                    <div class="esquadrao-content">
                        <div class="horse-list" id="hipoList">
                            <!-- Lista de cavalos Hipo -->
                        </div>
                    </div>
                </div>
                
                <div class="esquadrao-list">
                    <div class="esquadrao-header">
                        <span>DH</span>
                        <span class="esquadrao-count" id="dhCount">0 cavalos</span>
                    </div>
                    <div class="esquadrao-content">
                        <div class="horse-list" id="dhList">
                            <!-- Lista de cavalos DH -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="caderno-list" id="cadernoList">
                <!-- Conteúdo será preenchido via JavaScript -->
            </div>
            
            <div class="archived-visitas" id="archivedVisitas" style="display: none;">
                <h3 style="color: #2c7fb8; margin-bottom: 15px; font-size: 20px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0;">
                    Visitas Arquivadas
                </h3>
                <div class="archived-list" id="archivedList">
                    <!-- Conteúdo será preenchido via JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Criar Novo Caderno -->
    <div class="modal" id="cadernoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Criar Novo Caderno de Visitas</h2>
                <button class="close-modal" id="closeCadernoModal">&times;</button>
            </div>
            
            <form id="cadernoForm">
                <div class="form-group">
                    <label for="cadernoDate">Data da Visita</label>
                    <input type="date" id="cadernoDate" required>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="btnCancelCaderno">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Criar Caderno</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Visualizar Visita Arquivada -->
    <div class="modal" id="archivedModal">
        <div class="modal-content modal-wide">
            <div class="modal-archived-header">
                <div class="modal-archived-date" id="modalArchivedDate"></div>
                <button class="close-modal" id="closeArchivedModal">&times;</button>
            </div>
            
            <div class="modal-archived-content" id="modalArchivedContent">
                <!-- Conteúdo será preenchido via JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // ========== DADOS DAS VISITAS ==========
        // Função para carregar dados das visitas do localStorage
        function loadVisitasFromStorage() {
            const storedVisitas = localStorage.getItem('vetSystemVisitas');
            if (storedVisitas) {
                return JSON.parse(storedVisitas);
            } else {
                return {
                    cadernosAtivos: [],
                    cadernosArquivados: []
                };
            }
        }

        // Função para salvar dados das visitas no localStorage
        function saveVisitasToStorage() {
            localStorage.setItem('vetSystemVisitas', JSON.stringify(visitas));
        }

        // Função para carregar dados dos cavalos
        function loadHorsesFromStorage() {
            const storedHorses = localStorage.getItem('vetSystemHorses');
            if (storedHorses) {
                return JSON.parse(storedHorses);
            }
            return [];
        }

        // Carregar dados iniciais
        let visitas = loadVisitasFromStorage();
        let allHorses = loadHorsesFromStorage();
        let currentCaderno = null;

        // ========== ELEMENTOS DO DOM ==========
        const loggedUser = document.getElementById('loggedUser');
        const btnVoltar = document.getElementById('btnVoltar');
        const currentCadernoDate = document.getElementById('currentCadernoDate');
        const cadernoStatus = document.getElementById('cadernoStatus');
        const btnNovoCaderno = document.getElementById('btnNovoCaderno');
        const btnFinalizarVisita = document.getElementById('btnFinalizarVisita');
        const cadernoListsContainer = document.getElementById('cadernoListsContainer');
        const hipoList = document.getElementById('hipoList');
        const dhList = document.getElementById('dhList');
        const hipoCount = document.getElementById('hipoCount');
        const dhCount = document.getElementById('dhCount');
        const cadernoList = document.getElementById('cadernoList');
        const archivedList = document.getElementById('archivedList');
        const archivedVisitas = document.getElementById('archivedVisitas');
        const observacoesDia = document.getElementById('observacoesDia');
        
        // Modais
        const cadernoModal = document.getElementById('cadernoModal');
        const archivedModal = document.getElementById('archivedModal');
        const closeCadernoModal = document.getElementById('closeCadernoModal');
        const btnCancelCaderno = document.getElementById('btnCancelCaderno');
        const cadernoForm = document.getElementById('cadernoForm');
        const closeArchivedModal = document.getElementById('closeArchivedModal');
        const modalArchivedDate = document.getElementById('modalArchivedDate');
        const modalArchivedContent = document.getElementById('modalArchivedContent');

        // ========== FUNÇÕES PRINCIPAIS ==========
        // Inicializar a página
        function init() {
            // Carregar dados do usuário
            const userData = localStorage.getItem('vetSystemCurrentUser');
            if (userData) {
                const user = JSON.parse(userData);
                loggedUser.textContent = user.name;
            }

            renderVisitas();
            setupEventListeners();
        }

        // Configurar event listeners
        function setupEventListeners() {
            btnVoltar.addEventListener('click', voltarParaArquivos);
            btnNovoCaderno.addEventListener('click', openCadernoModal);
            btnFinalizarVisita.addEventListener('click', finalizarServicoVisitas);
            observacoesDia.addEventListener('input', saveObservacoes);
            
            // Modal caderno
            closeCadernoModal.addEventListener('click', closeCadernoModalFunc);
            btnCancelCaderno.addEventListener('click', closeCadernoModalFunc);
            cadernoForm.addEventListener('submit', saveCaderno);
            
            // Modal arquivados
            closeArchivedModal.addEventListener('click', closeArchivedModalFunc);
            
            // Fechar modais ao clicar fora
            window.addEventListener('click', (e) => {
                if (e.target === cadernoModal) closeCadernoModalFunc();
                if (e.target === archivedModal) closeArchivedModalFunc();
            });
        }

        // Voltar para a página de arquivos
        function voltarParaArquivos() {
            window.location.href = 'index.html';
        }

        // Renderizar visitas
        function renderVisitas() {
            // Verificar se há caderno ativo
            currentCaderno = visitas.cadernosAtivos.length > 0 ? visitas.cadernosAtivos[0] : null;
            
            if (currentCaderno) {
                currentCadernoDate.textContent = `Caderno de Visitas - ${formatDate(currentCaderno.data)}`;
                
                // Verificar se pode finalizar (dia seguinte a partir das 6:00)
                const canFinalize = canFinalizeVisita();
                if (canFinalize) {
                    cadernoStatus.textContent = 'Pronto para finalizar';
                    cadernoStatus.className = 'caderno-status active';
                    btnFinalizarVisita.disabled = false;
                } else {
                    cadernoStatus.textContent = 'Em andamento';
                    cadernoStatus.className = 'caderno-status pending';
                    btnFinalizarVisita.disabled = true;
                }
                
                cadernoListsContainer.style.display = 'grid';
                btnFinalizarVisita.disabled = !canFinalize;
                
                // Carregar observações
                observacoesDia.value = currentCaderno.observacoes || '';
            } else {
                currentCadernoDate.textContent = 'Nenhum caderno ativo';
                cadernoStatus.textContent = 'Inativo';
                cadernoStatus.className = 'caderno-status inactive';
                cadernoListsContainer.style.display = 'none';
                btnFinalizarVisita.disabled = true;
            }
            
            // Renderizar listas de cavalos
            renderHorseLists();
            
            // Renderizar visitas arquivadas
            renderArchivedList();
        }

        // Verificar se pode finalizar a visita
        function canFinalizeVisita() {
            if (!currentCaderno) return false;
            
            const hoje = new Date();
            const dataCaderno = new Date(currentCaderno.data);
            
            // Verificar se é dia seguinte
            const diaSeguinte = new Date(dataCaderno);
            diaSeguinte.setDate(diaSeguinte.getDate() + 1);
            diaSeguinte.setHours(6, 0, 0, 0); // A partir das 6:00
            
            return hoje >= diaSeguinte;
        }

        // Renderizar listas de cavalos
        function renderHorseLists() {
            hipoList.innerHTML = '';
            dhList.innerHTML = '';
            
            if (!currentCaderno) return;
            
            // Separar cavalos por esquadrão
            const cavalosHipo = [];
            const cavalosDH = [];
            
            allHorses.forEach(horse => {
                if (horse.esquadrao === 'Hipo') {
                    cavalosHipo.push(horse);
                } else if (horse.esquadrao === 'DH') {
                    cavalosDH.push(horse);
                }
            });
            
            // Verificar quais cavalos já estão na visita atual
            const cavalosNaVisita = new Set(currentCaderno.visitas.map(v => v.horseId));
            
            // Renderizar cavalos Hipo
            renderHorseList(hipoList, cavalosHipo, cavalosNaVisita);
            hipoCount.textContent = `${cavalosHipo.length} cavalos`;
            
            // Renderizar cavalos DH
            renderHorseList(dhList, cavalosDH, cavalosNaVisita);
            dhCount.textContent = `${cavalosDH.length} cavalos`;
        }

        // Renderizar lista de cavalos individual
        function renderHorseList(container, horses, cavalosNaVisita) {
            if (horses.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Nenhum cavalo registrado</div>';
                return;
            }
            
            horses.forEach(horse => {
                const isInVisita = cavalosNaVisita.has(horse.id);
                const visitaInfo = isInVisita ? 
                    currentCaderno.visitas.find(v => v.horseId === horse.id) : null;
                
                const horseItem = document.createElement('div');
                horseItem.className = 'horse-item';
                
                horseItem.innerHTML = `
                    <div class="horse-info">
                        <div class="horse-name">${horse.name}</div>
                        <div class="horse-id">ID: ${horse.id}</div>
                    </div>
                    <div class="horse-actions">
                        ${isInVisita ? `
                            <div class="visit-status">
                                <input type="checkbox" class="visit-status-checkbox" data-id="${horse.id}" ${visitaInfo.visited ? 'checked' : ''}>
                                <span>Visitado</span>
                            </div>
                            <button class="btn-remove" data-id="${horse.id}">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        ` : `
                            <button class="btn btn-primary btn-sm" data-id="${horse.id}">Adicionar</button>
                        `}
                    </div>
                `;
                
                container.appendChild(horseItem);
            });
            
            // Adicionar event listeners
            container.querySelectorAll('.btn-primary').forEach(btn => {
                btn.addEventListener('click', function() {
                    const horseId = parseInt(this.getAttribute('data-id'));
                    addHorseToVisita(horseId);
                });
            });
            
            container.querySelectorAll('.btn-remove').forEach(btn => {
                btn.addEventListener('click', function() {
                    const horseId = parseInt(this.getAttribute('data-id'));
                    removeHorseFromVisita(horseId);
                });
            });
            
            container.querySelectorAll('.visit-status-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const horseId = parseInt(this.getAttribute('data-id'));
                    updateVisitStatus(horseId, this.checked);
                });
            });
        }

        // Adicionar cavalo à visita
        function addHorseToVisita(horseId) {
            if (!currentCaderno) return;
            
            const horse = allHorses.find(h => h.id === horseId);
            if (!horse) return;
            
            // Verificar se já está na visita
            if (currentCaderno.visitas.some(v => v.horseId === horseId)) {
                return;
            }
            
            const novaVisita = {
                horseId: horse.id,
                name: horse.name,
                esquadrao: horse.esquadrao,
                visited: false,
                addedDate: new Date().toISOString()
            };
            
            currentCaderno.visitas.push(novaVisita);
            saveVisitasToStorage();
            renderVisitas();
        }

        // Remover cavalo da visita
        function removeHorseFromVisita(horseId) {
            if (!currentCaderno) return;
            
            const index = currentCaderno.visitas.findIndex(v => v.horseId === horseId);
            if (index !== -1) {
                currentCaderno.visitas.splice(index, 1);
                saveVisitasToStorage();
                renderVisitas();
            }
        }

        // Atualizar status da visita
        function updateVisitStatus(horseId, visited) {
            if (!currentCaderno) return;
            
            const visita = currentCaderno.visitas.find(v => v.horseId === horseId);
            if (visita) {
                visita.visited = visited;
                saveVisitasToStorage();
            }
        }

        // Salvar observações
        function saveObservacoes() {
            if (!currentCaderno) return;
            
            currentCaderno.observacoes = observacoesDia.value;
            saveVisitasToStorage();
        }

        // Renderizar lista de visitas arquivadas
        function renderArchivedList() {
            archivedList.innerHTML = '';
            
            if (visitas.cadernosArquivados.length === 0) {
                archivedVisitas.style.display = 'none';
                return;
            }
            
            archivedVisitas.style.display = 'block';
            
            // Ordenar por data (mais recente primeiro)
            const cadernosOrdenados = [...visitas.cadernosArquivados].sort((a, b) => 
                new Date(b.data) - new Date(a.data)
            );
            
            // Renderizar cada caderno arquivado
            cadernosOrdenados.forEach(caderno => {
                const visitasCount = caderno.visitas.length;
                const visitasRealizadas = caderno.visitas.filter(v => v.visited).length;
                const hasPending = visitasRealizadas < visitasCount;
                
                const archivedItem = document.createElement('div');
                archivedItem.className = 'archived-item';
                archivedItem.setAttribute('data-id', caderno.id);
                
                archivedItem.innerHTML = `
                    ${hasPending ? '<div class="warning-badge">!</div>' : ''}
                    <div class="archived-date">${formatDate(caderno.data)}</div>
                    <div class="archived-count">
                        ${visitasRealizadas}/${visitasCount} visitas realizadas
                    </div>
                `;
                
                archivedItem.addEventListener('click', () => openArchivedModal(caderno.id));
                archivedList.appendChild(archivedItem);
            });
        }

        // Abrir modal de visita arquivada
        function openArchivedModal(cadernoId) {
            const caderno = visitas.cadernosArquivados.find(c => c.id === cadernoId);
            if (!caderno) return;
            
            modalArchivedDate.textContent = `Visita do dia ${formatDate(caderno.data)}`;
            
            // Calcular estatísticas
            const totalVisitas = caderno.visitas.length;
            const visitasRealizadas = caderno.visitas.filter(v => v.visited).length;
            const visitasPendentes = totalVisitas - visitasRealizadas;
            
            // Separar por esquadrão
            const hipoVisitas = caderno.visitas.filter(v => v.esquadrao === 'Hipo');
            const dhVisitas = caderno.visitas.filter(v => v.esquadrao === 'DH');
            
            modalArchivedContent.innerHTML = `
                <div class="modal-archived-stats">
                    <div class="stat-box">
                        <div class="stat-number">${totalVisitas}</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${visitasRealizadas}</div>
                        <div class="stat-label">Realizadas</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${visitasPendentes}</div>
                        <div class="stat-label">Pendentes</div>
                    </div>
                </div>
                
                <div class="caderno-lists-container">
                    <div class="esquadrao-list">
                        <div class="esquadrao-header">
                            <span>Hipo</span>
                            <span class="esquadrao-count">${hipoVisitas.length} cavalos</span>
                        </div>
                        <div class="esquadrao-content">
                            ${renderArchivedHorseList(hipoVisitas)}
                        </div>
                    </div>
                    
                    <div class="esquadrao-list">
                        <div class="esquadrao-header">
                            <span>DH</span>
                            <span class="esquadrao-count">${dhVisitas.length} cavalos</span>
                        </div>
                        <div class="esquadrao-content">
                            ${renderArchivedHorseList(dhVisitas)}
                        </div>
                    </div>
                </div>
                
                ${caderno.observacoes ? `
                    <div class="modal-observacoes">
                        <h4>Observações do dia:</h4>
                        <p>${caderno.observacoes}</p>
                    </div>
                ` : ''}
            `;
            
            archivedModal.style.display = 'flex';
        }

        // Renderizar lista de cavalos arquivados
        function renderArchivedHorseList(visitas) {
            if (visitas.length === 0) {
                return '<div style="text-align: center; color: #666; padding: 20px;">Nenhum cavalo</div>';
            }
            
            return `
                <div class="horse-list">
                    ${visitas.map(visita => `
                        <div class="horse-item">
                            <div class="horse-info">
                                <div class="horse-name">${visita.name}</div>
                                <div class="horse-id">ID: ${visita.horseId}</div>
                            </div>
                            <div class="visit-status">
                                <span style="color: ${visita.visited ? '#27ae60' : '#e74c3c'}; font-weight: 600;">
                                    ${visita.visited ? '✓ Visitado' : '✗ Não visitado'}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Fechar modal arquivado
        function closeArchivedModalFunc() {
            archivedModal.style.display = 'none';
        }

        // Abrir modal para criar caderno
        function openCadernoModal() {
            // Definir data padrão como hoje
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('cadernoDate').value = today;
            cadernoModal.style.display = 'flex';
        }

        // Fechar modal do caderno
        function closeCadernoModalFunc() {
            cadernoModal.style.display = 'none';
        }

        // Criar novo caderno
        function createCaderno(data) {
            // Verificar se já existe um caderno ativo
            if (visitas.cadernosAtivos.length > 0) {
                if (!confirm('Já existe um caderno ativo. Deseja arquivá-lo e criar um novo?')) {
                    return;
                }
                
                // Arquivar caderno atual
                archiveCurrentCaderno(true);
            }
            
            const novoCaderno = {
                id: Date.now(),
                data: data,
                visitas: [],
                observacoes: '',
                createdAt: new Date().toISOString()
            };
            
            visitas.cadernosAtivos.push(novoCaderno);
            saveVisitasToStorage();
            currentCaderno = novoCaderno;
            renderVisitas();
            
            alert('Caderno criado com sucesso!');
        }

        // Finalizar serviço de visitas
        function finalizarServicoVisitas() {
            if (!currentCaderno) return;
            
            if (!canFinalizeVisita()) {
                alert('A visita só pode ser finalizada no dia seguinte, a partir das 6:00 da manhã.');
                return;
            }
            
            const visitasRealizadas = currentCaderno.visitas.filter(v => v.visited).length;
            const totalVisitas = currentCaderno.visitas.length;
            
            if (visitasRealizadas < totalVisitas) {
                if (!confirm(`${totalVisitas - visitasRealizadas} cavalo(s) não foram visitados. Deseja arquivar mesmo assim?`)) {
                    return;
                }
            }
            
            archiveCurrentCaderno(false);
        }

        // Arquivar caderno atual
        function archiveCurrentCaderno(silent = false) {
            if (!currentCaderno) return;
            
            // Mover caderno ativo para arquivados
            const index = visitas.cadernosAtivos.findIndex(c => c.id === currentCaderno.id);
            if (index !== -1) {
                // Adicionar data de arquivamento
                currentCaderno.archivedAt = new Date().toISOString();
                currentCaderno.archivedWithPending = currentCaderno.visitas.some(v => !v.visited);
                
                visitas.cadernosAtivos.splice(index, 1);
                visitas.cadernosArquivados.push(currentCaderno);
                saveVisitasToStorage();
                currentCaderno = null;
                renderVisitas();
                
                if (!silent) {
                    alert('Visita arquivada com sucesso!');
                }
            }
        }

        // Salvar caderno
        function saveCaderno(e) {
            e.preventDefault();
            
            const date = document.getElementById('cadernoDate').value;
            
            if (!date) {
                alert('Por favor, selecione uma data.');
                return;
            }
            
            createCaderno(date);
            closeCadernoModalFunc();
        }

        // ========== FUNÇÕES AUXILIARES ==========
        // Formatar data para exibição
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // ========== INICIALIZAÇÃO ==========
        // Iniciar a aplicação quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
